name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•å’Œç¼“å­˜

on:
  workflow_dispatch:
    inputs:
      workflow_name:
        type: choice
        description: 'æ¸…ç†çš„å·¥ä½œæµåç§°'
        required: true
        default: 'Build TCQT'
        options:
          - Build TCQT
      count:
        description: 'æœ€å¤šå¤„ç†çš„è¿è¡Œæ¬¡æ•°ï¼ˆ0=æ— é™åˆ¶ï¼‰'
        required: false
        default: '20'
      keep_latest:
        description: 'ä¿ç•™æœ€è¿‘å¤šå°‘æ¬¡è¿è¡Œä¸åˆ é™¤ï¼ˆæ— è®ºçŠ¶æ€ï¼‰'
        required: false
        type: number
        default: 0
      delete_failed:
        description: 'åˆ é™¤æŒ‡å®šå·¥ä½œæµå¤±è´¥çš„è¿è¡Œè®°å½•ï¼Ÿ'
        required: false
        type: boolean
        default: true
      delete_success:
        description: 'åˆ é™¤æŒ‡å®šå·¥ä½œæµæˆåŠŸçš„è¿è¡Œè®°å½•ï¼Ÿ'
        required: false
        type: boolean
        default: false
      delete_cancelled:
        description: 'åˆ é™¤æŒ‡å®šå·¥ä½œæµå–æ¶ˆçš„è¿è¡Œè®°å½•ï¼Ÿ'
        required: false
        type: boolean
        default: true
      reverse_order:
        description: 'ä»Žæ—§åˆ°æ–°å¼€å§‹æ¸…ç†ï¼Ÿ'
        required: false
        type: boolean
        default: false
      clear_cache:
        description: 'æ˜¯å¦åˆ é™¤æ‰€æœ‰ç¼“å­˜ï¼Ÿ'
        required: false
        type: boolean
        default: true
      cancel_all:
        description: 'æ˜¯å¦ä¸€é”®å–æ¶ˆæŒ‡å®šå·¥ä½œæµçš„æ‰€æœ‰è¿è¡Œï¼Ÿ'
        required: false
        type: boolean
        default: false

permissions:
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£…çŽ¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: è®¤è¯ GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: æ¸…ç†æŒ‡å®šå·¥ä½œæµè¿è¡Œè®°å½•
        env:
          REPO: ${{ github.repository }}
          COUNT: ${{ inputs.count }}
          KEEP_LATEST: ${{ inputs.keep_latest }}
          DELETE_FAILED: ${{ inputs.delete_failed }}
          DELETE_SUCCESS: ${{ inputs.delete_success }}
          DELETE_CANCELLED: ${{ inputs.delete_cancelled }}
          REVERSE_ORDER: ${{ inputs.reverse_order }}
          CANCEL_ALL: ${{ inputs.cancel_all }}
          WORKFLOW_NAME: ${{ inputs.workflow_name }}
          CURRENT_RUN_ID: ${{ github.run_id }}
        run: |
          set -e

          echo "ðŸ” æŸ¥æ‰¾å·¥ä½œæµ \"$WORKFLOW_NAME\" çš„ ID..."
          WORKFLOW_ID=$(gh api repos/$REPO/actions/workflows | jq -r ".workflows[] | select(.name == \"$WORKFLOW_NAME\") | .id")
          if [ -z "$WORKFLOW_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥ä½œæµ \"$WORKFLOW_NAME\"ï¼Œé€€å‡ºã€‚"
            exit 1
          fi

          echo "ðŸ“¥ å¼€å§‹åˆ†é¡µèŽ·å–æ‰€æœ‰è¿è¡Œè®°å½•..."
          PER_PAGE=100
          PAGE=1
          ALL_RUNS="[]"
          while true; do
            RESP=$(gh api "repos/$REPO/actions/workflows/$WORKFLOW_ID/runs?per_page=$PER_PAGE&page=$PAGE" 2>/dev/null || echo "{}")
            RUNS=$(echo "$RESP" | jq '.workflow_runs // []')
            COUNT_THIS_PAGE=$(echo "$RUNS" | jq 'length')
            if [ "$COUNT_THIS_PAGE" -eq 0 ]; then break; fi
            ALL_RUNS=$(jq -s 'add' <(echo "$ALL_RUNS") <(echo "$RUNS"))
            PAGE=$((PAGE + 1))
          done

          TOTAL_RUNS=$(echo "$ALL_RUNS" | jq 'length')
          echo "âœ… å…±èŽ·å–åˆ° $TOTAL_RUNS æ¡è¿è¡Œè®°å½•ã€‚"

          if [[ "$CANCEL_ALL" == "true" ]]; then
            echo "âœ‹ å¼€å§‹å–æ¶ˆè¿›è¡Œä¸­æˆ–æŽ’é˜Ÿä¸­çš„è¿è¡Œï¼ˆå½“å‰è¿è¡Œé™¤å¤–ï¼‰..."
            CANCEL_COUNT=0
            echo "$ALL_RUNS" | jq -c '.[] | select(.status == "in_progress" or .status == "queued")' | while read -r run; do
              ID=$(echo "$run" | jq -r '.id')
              if [[ "$ID" == "$CURRENT_RUN_ID" ]]; then continue; fi
              echo "  â†’ å–æ¶ˆè¿è¡Œ ID: $ID"
              if gh api -X POST "repos/$REPO/actions/runs/$ID/cancel" >/dev/null 2>&1; then
                CANCEL_COUNT=$((CANCEL_COUNT + 1))
              else
                echo "    âš ï¸  å–æ¶ˆå¤±è´¥"
              fi
            done
            echo "âœ… å·²å–æ¶ˆ $CANCEL_COUNT æ¡è¿è¡Œã€‚"
          fi

          echo "ðŸ§¹ å¼€å§‹å¤„ç†åˆ é™¤é€»è¾‘..."
          # æŽ’åºï¼šé»˜è®¤ä»Žæ–°åˆ°æ—§ï¼Œreverse_order=true åˆ™ä»Žæ—§åˆ°æ–°
          if [[ "$REVERSE_ORDER" == "true" ]]; then
            SORTED_RUNS=$(echo "$ALL_RUNS" | jq 'sort_by(.run_started_at)')
            echo "  â†’ æŽ’åºæ–¹å‘ï¼šä»Žæ—§åˆ°æ–°"
          else
            SORTED_RUNS=$(echo "$ALL_RUNS" | jq 'sort_by(.run_started_at) | reverse')
            echo "  â†’ æŽ’åºæ–¹å‘ï¼šä»Žæ–°åˆ°æ—§"
          fi

          # åº”ç”¨ keep_latestï¼šè·³è¿‡æœ€å‰é¢ N æ¡ï¼ˆæœ€æ–° N æ¡ï¼‰
          if [[ -n "$KEEP_LATEST" ]] && [[ "$KEEP_LATEST" -gt 0 ]]; then
            SORTED_RUNS=$(echo "$SORTED_RUNS" | jq ".[$KEEP_LATEST:]")
            echo "  â†’ å·²è·³è¿‡æœ€è¿‘ $KEEP_LATEST æ¡è¿è¡Œï¼ˆä¿ç•™ä¸åˆ ï¼‰"
          fi

          # åº”ç”¨ countï¼šæœ€å¤šå¤„ç†å‰ COUNT æ¡
          if [[ -n "$COUNT" ]] && [[ "$COUNT" -gt 0 ]]; then
            TO_DELETE_RUNS=$(echo "$SORTED_RUNS" | jq ".[0:$COUNT]")
            echo "  â†’ æœ€å¤šå¤„ç†å‰ $COUNT æ¡ç¬¦åˆæ¡ä»¶çš„è¿è¡Œ"
          else
            TO_DELETE_RUNS="$SORTED_RUNS"
            echo "  â†’ æ— æ•°é‡é™åˆ¶ï¼Œå¤„ç†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è¿è¡Œ"
          fi

          DELETED_COUNT=0
          echo "$TO_DELETE_RUNS" | jq -c '.[]' | while read -r run; do
            ID=$(echo "$run" | jq -r '.id')
            STATUS=$(echo "$run" | jq -r '.conclusion')
            STATE=$(echo "$run" | jq -r '.status')

            # è·³è¿‡è¿›è¡Œä¸­æˆ–æŽ’é˜Ÿä¸­çš„è¿è¡Œï¼ˆä¸åº”åˆ é™¤ï¼‰
            if [[ "$STATE" == "in_progress" || "$STATE" == "queued" ]]; then
              echo "  â†’ è·³è¿‡è¿è¡Œ ID: $IDï¼ˆçŠ¶æ€ï¼š$STATEï¼‰"
              continue
            fi

            # æ ¹æ®çŠ¶æ€åˆ¤æ–­æ˜¯å¦åˆ é™¤
            if [[ "$STATUS" == "failure" && "$DELETE_FAILED" != "true" ]]; then continue; fi
            if [[ "$STATUS" == "success" && "$DELETE_SUCCESS" != "true" ]]; then continue; fi
            if [[ "$STATUS" == "cancelled" && "$DELETE_CANCELLED" != "true" ]]; then continue; fi

            echo "  â†’ åˆ é™¤è¿è¡Œè®°å½• ID: $IDï¼ˆçŠ¶æ€ï¼š$STATUSï¼‰"
            if gh api -X DELETE "repos/$REPO/actions/runs/$ID" >/dev/null 2>&1; then
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "    âš ï¸  åˆ é™¤å¤±è´¥"
            fi
          done

          echo "âœ… æœ¬æ¬¡å…±åˆ é™¤ $DELETED_COUNT æ¡è¿è¡Œè®°å½•ã€‚"

          echo "ðŸ§¹ æ¸…ç†æœ¬å·¥ä½œæµåŽ†å²è¿è¡Œè®°å½•ï¼ˆæŽ’é™¤å½“å‰è¿è¡Œï¼‰..."
          SELF_WORKFLOW_ID=$(gh api repos/$REPO/actions/workflows | jq -r '.workflows[] | select(.name == "æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•å’Œç¼“å­˜") | .id')
          if [ -n "$SELF_WORKFLOW_ID" ]; then
            SELF_RUNS=$(gh api "repos/$REPO/actions/workflows/$SELF_WORKFLOW_ID/runs?per_page=50" | jq -c '.workflow_runs[]')
            SELF_DELETED=0
            echo "$SELF_RUNS" | while read -r run; do
              ID=$(echo "$run" | jq -r '.id')
              if [[ "$ID" == "$CURRENT_RUN_ID" ]]; then continue; fi
              echo "  â†’ åˆ é™¤æœ¬å·¥ä½œæµè¿è¡Œè®°å½• ID: $ID"
              if gh api -X DELETE "repos/$REPO/actions/runs/$ID" >/dev/null 2>&1; then
                SELF_DELETED=$((SELF_DELETED + 1))
              else
                echo "    âš ï¸  åˆ é™¤å¤±è´¥"
              fi
            done
            echo "âœ… å·²åˆ é™¤æœ¬å·¥ä½œæµ $SELF_DELETED æ¡åŽ†å²è®°å½•ã€‚"
          else
            echo "âš ï¸  æœªæ‰¾åˆ°æœ¬å·¥ä½œæµå®šä¹‰ï¼Œè·³è¿‡è‡ªæˆ‘æ¸…ç†ã€‚"
          fi

  clean-caches:
    runs-on: ubuntu-latest
    needs: cleanup
    if: ${{ inputs.clear_cache == true || inputs.clear_cache == 'true' }}
    permissions:
      actions: write
    steps:
      - name: åˆ é™¤å¹¶é‡ç½® gradleã€android-buildã€kspã€protobuf ç¼“å­˜
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            let totalDeleted = 0;
            let page = 1;
            const cacheTypes = ['gradle-', 'android-build-', 'ksp-', 'protobuf-'];

            core.info('ðŸ” å¼€å§‹æ‰«æç¼“å­˜...');

            while (true) {
              const res = await github.rest.actions.getActionsCacheList({
                owner,
                repo,
                per_page: 100,
                page: page
              });

              const caches = res.data.actions_caches;
              if (!caches || caches.length === 0) break;

              for (const cache of caches) {
                const shouldDelete = cacheTypes.some(prefix => cache.key.startsWith(prefix));
                if (shouldDelete) {
                  core.info(`ðŸ§¹ åˆ é™¤ç¼“å­˜: ${cache.key} (ID: ${cache.id})`);
                  await github.rest.actions.deleteActionsCacheById({
                    owner,
                    repo,
                    cache_id: cache.id
                  });
                  totalDeleted++;
                }
              }

              if (caches.length < 100) break;
              page++;
            }

            if (totalDeleted === 0) {
              core.info('âœ… æœªæ‰¾åˆ°ä»¥ "gradle-"ã€"android-build-"ã€"ksp-"ã€"protobuf-" å¼€å¤´çš„ç¼“å­˜ï¼Œæ— éœ€æ¸…ç†ã€‚');
            } else {
              core.info(`âœ… å…±åˆ é™¤ç¼“å­˜æ•°é‡: ${totalDeleted}`);
            }
