<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TCQT</title>

    <!-- Bootstrap 5.3.7 + Icons -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Animate.css for smooth animations -->
    <link href="https://cdn.bootcdn.net/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        :root {
          --primary-color: #4361ee;
          --primary-light: #4cc9f0;
          --text-dark: #333;
          --text-light: #555;
          --bg-light: #f8f9fa;
          --card-bg: #ffffff;
          --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
          --border-color: #e0e0e0;
          --success-color: #28a745;
          --danger-color: #dc3545;
          --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
          background: var(--bg-light);
          color: var(--text-dark);
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
          padding: 16px;
          margin: 0;
          min-height: 100vh;
          background-image:
            radial-gradient(circle at 20% 30%, rgba(67, 97, 238, 0.05) 0%, transparent 30%),
            radial-gradient(circle at 80% 70%, rgba(76, 201, 240, 0.05) 0%, transparent 30%);
        }

        .container {
          max-width: 640px;
          margin: 20px auto;
          display: none;
        }

        /* Glassmorphic Card */
        .card {
          border: none;
          border-radius: 24px;
          box-shadow: var(--shadow);
          overflow: hidden;
          background: var(--card-bg);
          backdrop-filter: blur(12px);
          background: rgba(255, 255, 255, 0.85);
          transition: var(--transition);
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 12px 36px rgba(67, 97, 238, 0.18);
        }

        .card-header {
          background: transparent;
          border-bottom: 1px solid var(--border-color);
          padding: 32px 24px 24px;
          text-align: center;
        }

        .card-header h2 {
          font-weight: 700;
          color: var(--primary-color);
          margin: 0 0 8px 0;
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 10px;
        }

        .version-info {
          margin-top: 12px;
          font-size: 0.95rem;
          text-align: left;
          display: inline-block;
        }

        .version-row {
          display: flex;
          align-items: center;
          margin-bottom: 4px;
        }

        .version-label {
          min-width: 7em;
          color: var(--text-light);
          font-weight: 500;
        }

        .version-success {
          color: var(--success-color);
          font-weight: 600;
        }

        .version-fail {
          color: var(--danger-color);
          font-weight: 500;
        }

        /* Feature List */
        .list-group-item {
          border: none;
          padding: 16px 24px;
          border-bottom: 1px solid var(--border-color);
          transition: var(--transition);
          cursor: pointer;
          position: relative;
        }

        .list-group-item:hover {
          background-color: rgba(67, 97, 238, 0.03);
        }

        .feature-label {
          font-weight: 600;
          font-size: 1.05rem;
          display: flex;
          align-items: center;
          gap: 10px;
          user-select: none;
        }

        .feature-label i {
          opacity: 0.7;
          font-size: 0.95rem;
          transition: transform 0.3s ease;
        }

        .feature-label.expanded i {
          transform: rotate(180deg);
        }

        .feature-desc {
          font-size: 0.92rem;
          color: var(--text-light);
          margin: 10px 0 0;
          opacity: 0;
          max-height: 0;
          overflow: hidden;
          transition: all 0.3s ease;
        }

        .feature-desc.show {
          opacity: 1;
          max-height: 120px;
          margin: 10px 0;
        }

        /* Switch Styling */
        .form-switch .form-check-input {
          background-color: #ced4da;
          border: none;
          box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
          transition: var(--transition);
        }

        .form-switch .form-check-input:checked {
          background-color: var(--primary-color);
          box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        .form-switch .form-check-input:focus {
          outline: none;
          box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
        }

        .form-switch .form-check-input:hover {
          scale: 1.08;
        }

        /* Save Button */
        .btn-save {
          margin: 20px 24px;
          padding: 14px;
          font-size: 1.1rem;
          font-weight: 600;
          border-radius: 14px;
          background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
          border: none;
          color: white;
          box-shadow: 0 6px 16px rgba(67, 97, 238, 0.35);
          transition: var(--transition);
          user-select: none;
          width: calc(100% - 48px);
        }

        .btn-save:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 10px 20px rgba(67, 97, 238, 0.45);
        }

        .btn-save:active:not(:disabled) {
          transform: translateY(0);
        }

        .btn-save:disabled {
          background: #adb5bd;
          box-shadow: none;
          cursor: not-allowed;
          opacity: 0.7;
        }

        /* Toast System */
        #toast-container {
          position: fixed;
          bottom: 30px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 10000;
          pointer-events: none;
          width: max-content;
          max-width: 90%;
        }

        .toast-item {
          background-color: #333;
          color: white;
          padding: 14px 24px;
          border-radius: 10px;
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
          margin-bottom: 10px;
          font-size: 0.95rem;
          opacity: 0;
          transform: translateY(20px);
          pointer-events: auto;
          animation: fadeInUp 0.3s forwards, fadeOutDown 0.3s 2.2s forwards;
        }

        @keyframes fadeInUp {
          to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOutDown {
          to { opacity: 0; transform: translateY(20px); }
        }

        /* Loading Screen */
        #loading {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          text-align: center;
          color: #555;
          user-select: none;
          z-index: 9999;
        }

        #loading .spinner-border {
          width: 3.5rem;
          height: 3.5rem;
          border-width: 0.3em;
          border-color: var(--primary-color) transparent transparent transparent;
        }

        /* Textarea */
        textarea {
          font-family: 'Courier New', monospace;
          font-size: 0.9rem;
          padding: 10px;
          border-radius: 8px;
          border: 1px solid #ced4da;
          background-color: #fdfdfd;
          transition: var(--transition);
          width: 100%;
          min-height: 60px;
          box-sizing: border-box;
          resize: vertical;
          line-height: 1.4;
        }

        textarea:focus {
          border-color: var(--primary-color);
          box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
          outline: none;
        }

        .textarea-container {
          display: none;
          margin-top: 12px;
          padding: 12px;
          background-color: #f9f9fc;
          border-radius: 10px;
          border: 1px solid var(--border-color);
          width: 100%;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
          width: 6px;
          height: 6px;
        }

        ::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
          background: #c0c0c0;
          border-radius: 10px;
          transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
          background: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 480px) {
          .container {
            margin: 10px auto;
            padding: 0 10px;
          }
          .card-header h2 {
            font-size: 1.3rem;
          }
        }
    </style>
</head>
<body>

<!-- 加载动画 -->
<div id="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">加载中...</span>
    </div>
    <p class="mt-3 text-muted">正在初始化设置...</p>
</div>

<!-- 主体内容 -->
<div class="container">
    <div class="card animate__animated animate__fadeIn">
        <div class="card-header">
            <h2><i class="bi bi-sliders"></i> TCQT 模块设置</h2>
            <div class="version-info">
                <div class="version-row">
                    <span class="version-label">宿主版本:</span>
                    <span id="qqVersion" class="version-fail">加载中...</span>
                </div>
                <div class="version-row">
                    <span class="version-label">模块版本:</span>
                    <span id="moduleVersion" class="version-fail">加载中...</span>
                </div>
            </div>
            <small class="text-muted mt-2 d-block">
                启用或禁用功能，保存后重启宿主生效。
            </small>
        </div>
        <ul id="feature-list" class="list-group list-group-flush"></ul>
        <button id="btnSave" class="btn-save">保存设置</button>
    </div>
</div>

<!-- Toast 容器 -->
<div id="toast-container"></div>

<script>
    const features = [
      { key: "change_guid", label: "自定义 GUID", desc: "启用后在登录页面长按登录按钮即可调出设置窗口。" },
      { key: "default_bubble", label: "强制使用默认气泡", desc: "使用默认气泡，让花里胡哨的气泡不那么花里胡哨。" },
      { key: "default_font", label: "强制使用默认字体", desc: "使用默认字体，让花里胡哨的字体不那么花里胡哨。" },
      { key: "disable_flash_pic", label: "将闪照视为正常图片", desc: "好友发送的闪照将作为正常图片显示并添加灰条提示。" },
      { key: "disable_hot_patch", label: "禁用热补丁", desc: "顾名思义，但不会删除已有的热补丁。" },
      { key: "disable_reaction_limit", label: "禁止过滤反应表情", desc: "将更多的表情（Emoji）显示出来。" },
      { key: "exclude_send_cmd", label: "禁止发送指定包体", desc: "启用后，宿主发送的指定包体(cmd)将会被拦截。" },
      { key: "fake_multi_window_status", label: "伪造多窗口状态", desc: "不知道有什么用。" },
      { key: "fetch_service", label: "消息防撤回", desc: "防止消息被撤回，添加灰条提示。" },
      { key: "flag_secure_bypass", label: "绕过FlagSecure", desc: "绕过FlagSecure，允许截图和录屏。" },
      { key: "login_check_box_default", label: "自动勾选复选框", desc: "登录界面自动勾选复选框（用户协议，有人看了吗）。" },
      { key: "module_update", label: "模块更新重启宿主", desc: "启用后，每次本模块更新后，将自动重启（杀死）宿主进程。" },
      { key: "one_click_likes", label: "一键20赞", desc: "开启后点赞时将自动点赞20个（非SVIP为10个）。" },
      { key: "poke_no_cool_down", label: "戳一戳无冷却", desc: "移除戳一戳冷却时间。" },
      { key: "remove_qr_login_check", label: "移除扫码登录检查", desc: "扫描相册里的二维码时不再拦截登录。" },
      { key: "rename_base_apk", label: "重命名.apk文件", desc: "上传群文件时自动重命名 .apk 文件，防止添加.1。" },
      { key: "reply_no_at", label: "回复不带 @", desc: "回复消息时不添加 @ 对方。" },
      { key: "skip_qr_login_wait", label: "跳过扫码登录等待", desc: "扫码登录时跳过倒计时。" }
    ];

    let injected = false;

    function setVersionText(id, text, success) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text;
      el.classList.remove("version-success", "version-fail");
      el.classList.add(success ? "version-success" : "version-fail");
    }

    async function loadVersions() {
      return new Promise((resolve) => {
        setTimeout(() => {
          if (typeof TCQT !== "undefined") {
            try {
              const hostName = TCQT.getHostName() || "QQ";
              const qqVersion = TCQT.getQQVersion() || "未知";
              const moduleName = TCQT.getModuleName() || "TCQT";
              const moduleVersion = TCQT.getModuleVersion() || "未知";

              setVersionText("qqVersion", `${hostName} ${qqVersion}`, true);
              setVersionText("moduleVersion", `${moduleName} ${moduleVersion}`, true);
              injected = true;
            } catch (e) {
              console.error("获取版本失败", e);
              setVersionText("qqVersion", "获取失败", false);
              setVersionText("moduleVersion", "获取失败", false);
              injected = false;
            }
          } else {
            console.error("TCQT 对象未定义");
            setVersionText("qqVersion", "环境异常", false);
            setVersionText("moduleVersion", "环境异常", false);
            injected = false;
          }
          resolve();
        }, 50);
      });
    }

    function renderFeatures() {
      const container = document.getElementById("feature-list");
      container.innerHTML = "";

      features.forEach(feature => {
        const li = document.createElement("li");
        li.className = "list-group-item";

        // 动态生成结构
        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="feature-label">
                <i class="bi bi-chevron-down"></i>
                ${feature.label}
              </div>
              <div class="feature-desc">${feature.desc || ""}</div>
            </div>
            <div class="form-check form-switch ms-3">
              <input class="form-check-input" type="checkbox" id="switch-${feature.key}" role="switch">
            </div>
          </div>
        `;

        // 添加 exclude_send_cmd 的 textarea 容器
        if (feature.key === "exclude_send_cmd") {
          const textareaContainer = document.createElement("div");
          textareaContainer.className = "textarea-container";
          textareaContainer.id = "container-textarea-exclude_send_cmd";

          const textarea = document.createElement("textarea");
          textarea.id = "textarea-exclude_send_cmd_string";
          textarea.placeholder = "不了解不要启用本功能!!!\n填写欲禁止发送包体的cmd\n一行一个，正则表达式(以!开头表示)";
          textarea.rows = 4;
          textareaContainer.appendChild(textarea);
          li.appendChild(textareaContainer);
        }

        const label = li.querySelector(".feature-label");
        const desc = li.querySelector(".feature-desc");
        const checkbox = li.querySelector("input[type=checkbox]");
        const textareaContainer = li.querySelector(".textarea-container");

        // 点击标题展开/收起
        label.addEventListener("click", () => {
          const isExpanded = desc.classList.contains("show");
          desc.classList.toggle("show", !isExpanded);
          label.classList.toggle("expanded", !isExpanded);
          const icon = label.querySelector("i");
          icon.className = isExpanded ? "bi bi-chevron-down" : "bi bi-chevron-up";

          if (textareaContainer) {
            textareaContainer.style.display = isExpanded ? "none" : "block";
          }
        });

        // 阻止 checkbox 冒泡
        checkbox.addEventListener("click", e => e.stopPropagation());

        container.appendChild(li);
      });
    }

    function initSettings() {
      features.forEach(feature => {
        const checkbox = document.getElementById("switch-" + feature.key);
        if (!checkbox) return;

        if (injected) {
          try {
            const settingJson = TCQT.getSetting(feature.key);
            const setting = JSON.parse(settingJson);
            checkbox.checked = !!setting.value;
          } catch (e) {
            checkbox.checked = false;
          }

          if (feature.key === "exclude_send_cmd") {
            const textarea = document.getElementById("textarea-exclude_send_cmd_string");
            if (textarea) {
              try {
                const strJson = TCQT.getSetting("exclude_send_cmd_string");
                const strSetting = JSON.parse(strJson);
                textarea.value = strSetting.value || "";
              } catch (e) {
                textarea.value = "";
              }
            }
          }
        } else {
          checkbox.disabled = true;
          if (feature.key === "exclude_send_cmd") {
            const textarea = document.getElementById("textarea-exclude_send_cmd_string");
            if (textarea) textarea.disabled = true;
          }
        }
      });

      document.getElementById("btnSave").disabled = !injected;
    }

    function saveSettings() {
      if (!injected) {
        showToast("模块接口未注入，无法保存设置");
        return;
      }

      features.forEach(feature => {
        const checked = document.getElementById("switch-" + feature.key).checked;
        try {
          TCQT.setSettingBoolean(feature.key, checked);
        } catch (e) {
          console.error(`设置 ${feature.key} 失败`, e);
        }
      });

      const textarea = document.getElementById("textarea-exclude_send_cmd_string");
      if (textarea) {
        const textValue = textarea.value.trim();
        try {
          TCQT.setSettingString("exclude_send_cmd_string", textValue);
        } catch (e) {
          console.error("保存 exclude_send_cmd_string 失败", e);
        }
      }

      const hostName = TCQT.getHostName() || "应用";
      showToast(`设置已保存，重启 ${hostName} 后生效`);
    }

    function showToast(msg) {
      if (typeof TCQT !== "undefined" && typeof TCQT.toast === "function") {
        try {
          TCQT.toast(msg);
          return;
        } catch (e) {}
      }

      // DOM Toast fallback
      const toastContainer = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast-item animate__animated";
      toast.textContent = msg;
      toastContainer.appendChild(toast);

      // 自动移除
      setTimeout(() => {
        toast.remove();
      }, 2500);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnSave").addEventListener("click", saveSettings);
    });

    (async function init() {
      try {
        await loadVersions();
        renderFeatures();
        initSettings();
      } catch (err) {
        console.error("初始化失败:", err);
        setVersionText("qqVersion", "初始化失败", false);
        setVersionText("moduleVersion", "初始化失败", false);
        document.getElementById("btnSave").disabled = true;
      } finally {
        document.getElementById("loading").style.display = "none";
        document.querySelector(".container").style.display = "block";
      }
    })();
</script>
</body>
</html>
