<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /><title>TCQT</title><link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet"><style>:root{--primary-color:#3b82f6;--primary-light:#60a5fa;--text-dark:#111827;--text-muted:#6b7280;--text-light:#f9fafb;--bg-body:#f9fafb;--bg-card:#ffffff;--border-color:#e5e7eb;--success-color:#10b981;--danger-color:#ef4444;--warning-color:#f59e0b;--shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.05);--shadow-md:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);--shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1),0 4px 6px -4px rgb(0 0 0 / 0.1);--radius-sm:6px;--radius-md:8px;--radius-lg:12px;--transition-fast:all 0.15s cubic-bezier(0.4,0,0.2,1);--transition-smooth:all 0.25s cubic-bezier(0.4,0,0.2,1);--transition-expand:all 0.4s cubic-bezier(0.4,0,0.2,1);}.dark-mode{--text-dark:#f9fafb;--text-muted:#d1d5db;--text-light:#111827;--bg-body:#111827;--bg-card:#1f2937;--border-color:#374151;--shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.3);--shadow-md:0 4px 6px -1px rgb(0 0 0 / 0.2),0 2px 4px -2px rgb(0 0 0 / 0.2);--shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.3),0 4px 6px -4px rgb(0 0 0 / 0.2);}.dark-mode .version-success{background-color:rgba(16,185,129,0.2);}.dark-mode .version-fail{background-color:rgba(239,68,68,0.2);}.dark-mode .header-notice{background-color:#1f2937;border-color:#374151;color:var(--text-muted);}.dark-mode .feature-item.is-expanded{background-color:rgba(59,130,246,0.1);}.dark-mode .feature-item.is-expanded .textarea-container:not(:empty){background-color:rgba(59,130,246,0.15);border-color:#60a5fa;}.dark-mode .feature-item:hover{background-color:rgba(59,130,246,0.1);}.dark-mode textarea{background-color:#181a1f;color:var(--text-dark);border-color:var(--border-color);}.dark-mode textarea:focus{background-color:#181a1f;border-color:var(--primary-color);box-shadow:0 0 0 4px rgba(59,130,246,0.15);}.dark-mode textarea::placeholder{color:#8a8e99;}.dark-mode textarea:disabled{background-color:#374151;color:#6b7280;}.dark-mode .fab-save:disabled{background:#4b5563;}.dark-mode .footer-link a:hover{background-color:rgba(59,130,246,0.15);}.dark-mode .toast-item{background-color:rgba(249,250,251,0.95);color:#111827;box-shadow:var(--shadow-md);}.dark-mode .slider{background-color:#4b5563;}.dark-mode input:checked + .slider{background-color:var(--primary-color);}.dark-mode input:disabled + .slider{background-color:#6b7280;}*,*::before,*::after{box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background-color:var(--bg-body);color:var(--text-dark);margin:0;padding:16px;min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent;transition:background-color var(--transition-smooth),color var(--transition-smooth);overflow-x:hidden;position:relative;}.bg-animation{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.03;pointer-events:none;}.floating-shape{position:absolute;border-radius:50%;background:var(--primary-color);filter:blur(40px);animation:float 15s infinite ease-in-out;}.shape-1{width:300px;height:300px;top:10%;left:5%;animation-delay:0s;background:linear-gradient(45deg,#3b82f6,#8b5cf6);}.shape-2{width:200px;height:200px;top:60%;right:10%;animation-delay:-5s;background:linear-gradient(45deg,#10b981,#3b82f6);}.shape-3{width:250px;height:250px;bottom:10%;left:20%;animation-delay:-10s;background:linear-gradient(45deg,#f59e0b,#ef4444);}@keyframes float{0%,100%{transform:translate(0,0) rotate(0deg);}25%{transform:translate(20px,30px) rotate(5deg);}50%{transform:translate(-15px,20px) rotate(-5deg);}75%{transform:translate(10px,-15px) rotate(3deg);}}.loading-overlay{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:var(--bg-body);z-index:10000;transition:opacity var(--transition-smooth);opacity:1;}.loading-overlay .spinner{width:60px;height:60px;border:3px solid rgba(59,130,246,0.2);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite,pulse 2s infinite ease-in-out;position:relative;}.loading-overlay .spinner::after{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;border:3px solid rgba(59,130,246,0.1);border-radius:50%;animation:spin 1.5s linear infinite reverse;}.loading-overlay p{margin-top:16px;color:var(--text-muted);font-weight:500;font-size:0.9rem;animation:fadeInOut 2s infinite ease-in-out;}@keyframes spin{to{transform:rotate(360deg);}}@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}@keyframes fadeInOut{0%,100%{opacity:0.6;}50%{opacity:1;}}.app-container{max-width:720px;margin:0 auto;display:none;opacity:0;transform:translateY(8px);transition:opacity var(--transition-smooth),transform var(--transition-smooth);}.app-container.visible{display:block;opacity:1;transform:translateY(0);}.app-header{text-align:center;margin-bottom:24px;position:relative;}.app-header h1{font-size:1.875rem;font-weight:700;color:var(--text-dark);display:flex;align-items:center;justify-content:center;gap:8px;margin:0;position:relative;z-index:1;}.version-info{display:flex;justify-content:center;margin-top:12px;font-size:0.85rem;}.version-info-wrapper{display:inline-flex;flex-direction:row;align-items:center;gap:20px;}.version-item{color:var(--text-muted);display:flex;align-items:center;gap:4px;transition:var(--transition-smooth);}.version-item:hover{transform:translateY(-2px);}.version-item span{font-weight:600;padding:3px 6px;border-radius:var(--radius-sm);font-size:0.8rem;transition:var(--transition-smooth);}.version-success{color:var(--success-color);background-color:rgba(16,185,129,0.1);}.version-fail{color:var(--danger-color);background-color:rgba(239,68,68,0.1);}.header-notice{font-size:0.85rem;color:var(--text-muted);background-color:var(--bg-card);padding:12px;border-radius:var(--radius-md);margin-top:16px;max-width:500px;margin-left:auto;margin-right:auto;border:1px solid var(--border-color);box-shadow:var(--shadow-sm);transition:var(--transition-smooth);position:relative;overflow:hidden;}.header-notice::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(59,130,246,0.1),transparent);transition:left 0.5s ease;}.header-notice:hover::before{left:100%;}.header-notice strong{color:var(--danger-color);}.action-status{font-size:0.85rem;text-align:center;margin-top:8px;font-weight:500;}.status-enabled{color:var(--success-color);font-weight:600;}.status-disabled{color:var(--warning-color);font-weight:600;}.feature-list{background-color:var(--bg-card);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);overflow:hidden;border:1px solid var(--border-color);transition:var(--transition-smooth);position:relative;}.feature-list::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary-color),var(--success-color),var(--warning-color),var(--danger-color));background-size:400% 100%;animation:gradientShift 8s infinite linear;}@keyframes gradientShift{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}.feature-item{padding:16px 20px;border-bottom:1px solid var(--border-color);transition:var(--transition-smooth);position:relative;overflow:hidden;}.feature-item::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(59,130,246,0.05),transparent);transition:left 0.5s ease;}.feature-item:hover::before{left:100%;}.feature-item:hover{background-color:rgba(59,130,246,0.02);transform:translateX(5px);}.feature-item:last-child{border-bottom:none;}.feature-item.is-expanded{background-color:rgba(59,130,246,0.03);}.feature-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;padding:2px 0;}.feature-title{font-weight:600;display:flex;align-items:center;gap:8px;font-size:1rem;}.feature-title .icon-toggle{transition:var(--transition-smooth);color:var(--text-muted);font-size:0.8rem;}.feature-item.is-expanded .icon-toggle{transform:rotate(180deg);color:var(--primary-color);}.feature-desc,.textarea-container{font-size:0.875rem;color:var(--text-muted);margin-top:0;padding:0 0;max-height:0;opacity:0;overflow:hidden;transition:var(--transition-expand);}.textarea-container{display:flex;flex-direction:column;gap:8px;padding:0;margin:0;}.feature-item.is-expanded .feature-desc{margin-top:8px;padding:0 0 8px 0;}.feature-item.is-expanded .textarea-container:not(:empty){margin-top:8px;padding:12px 0;background-color:rgba(59,130,246,0.05);border-radius:var(--radius-sm);border:1px solid var(--border-color);padding-left:16px;padding-right:16px;}.feature-item.is-expanded .feature-desc,.feature-item.is-expanded .textarea-container{max-height:1000px;opacity:1;}.switch-container{display:flex;align-items:center;gap:8px;}.switch{position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;}.switch input{opacity:0;width:0;height:0;}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#d1d5db;transition:var(--transition-smooth);border-radius:24px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);}.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:var(--transition-smooth);border-radius:50%;box-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1),0 1px 2px -1px rgb(0 0 0 / 0.1);}input:checked + .slider{background-color:var(--primary-color);box-shadow:0 0 10px rgba(59,130,246,0.5);}input:checked + .slider:before{transform:translateX(20px);animation:switchBounce 0.3s ease;}@keyframes switchBounce{0%{transform:translateX(0) scale(1);}50%{transform:translateX(10px) scale(1.2);}100%{transform:translateX(20px) scale(1);}}input:focus-visible + .slider{box-shadow:0 0 0 3px rgba(59,130,246,0.25);}input:disabled + .slider{background-color:#9ca3af;cursor:not-allowed;}textarea{width:100%;font-family:inherit;font-size:0.9rem;line-height:1.5;padding:14px 16px;border-radius:10px;border:1.5px solid var(--border-color);background-color:#ffffff;color:var(--text-dark);resize:vertical;min-height:120px;transition:border-color var(--transition-fast),box-shadow var(--transition-fast);}textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px rgba(59,130,246,0.15);animation:textareaPulse 2s infinite;}@keyframes textareaPulse{0%,100%{box-shadow:0 0 0 4px rgba(59,130,246,0.15);}50%{box-shadow:0 0 0 6px rgba(59,130,246,0.1);}}textarea::placeholder{color:#9ca3af;font-size:0.85rem;}textarea:disabled{background-color:#f3f4f6;color:#9ca3af;cursor:not-allowed;}.fab-save{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:linear-gradient(135deg,var(--primary-color),var(--primary-light));color:var(--text-light);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.25rem;box-shadow:var(--shadow-md);cursor:pointer;z-index:1000;transition:var(--transition-smooth);user-select:none;}.fab-save:hover:not(:disabled){transform:translateY(-2px) scale(1.05);box-shadow:0 20px 25px -5px rgb(59,130,246 / 0.3);}.fab-save:active:not(:disabled){transform:translateY(0) scale(0.98);}.fab-save:disabled{background:#d1d5db;box-shadow:var(--shadow-sm);cursor:not-allowed;transform:none;opacity:0.6;}.fab-save.pulse{animation:pulse 1.5s infinite,floatButton 3s infinite ease-in-out;}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,0.7);}70%{box-shadow:0 0 0 10px rgba(59,130,246,0);}100%{box-shadow:0 0 0 0 rgba(59,130,246,0);}}@keyframes floatButton{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}.footer-link{text-align:center;margin:32px 0;}.footer-link a{color:var(--text-muted);text-decoration:none;font-weight:500;padding:8px 16px;border-radius:var(--radius-md);display:inline-flex;align-items:center;gap:6px;transition:var(--transition-fast);border:1px solid transparent;position:relative;overflow:hidden;}.footer-link a::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(59,130,246,0.1),transparent);transition:left 0.5s ease;}.footer-link a:hover::before{left:100%;}.footer-link a:hover{background-color:rgba(59,130,246,0.05);color:var(--primary-color);border-color:rgba(59,130,246,0.2);transform:translateY(-2px);}.toast-container{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:10001;pointer-events:none;display:flex;flex-direction:column;align-items:center;gap:8px;}.toast-item{background-color:rgba(17,24,39,0.95);color:var(--text-light);padding:10px 20px;border-radius:var(--radius-md);box-shadow:var(--shadow-md);font-size:0.9rem;font-weight:500;animation:slideUpFadeIn 0.3s ease forwards,slideDownFadeOut 0.3s 2.7s forwards;min-width:260px;text-align:center;position:relative;overflow:hidden;}.toast-item::before{content:'';position:absolute;bottom:0;left:0;height:3px;width:100%;background:linear-gradient(90deg,var(--primary-color),var(--success-color));animation:toastProgress 3s linear forwards;}@keyframes toastProgress{from{width:100%;}to{width:0%;}}@keyframes slideUpFadeIn{from{opacity:0;transform:translateY(20px) translateX(-50%);}to{opacity:1;transform:translateY(0) translateX(-50%);}}@keyframes slideDownFadeOut{from{opacity:1;transform:translateY(0) translateX(-50%);}to{opacity:0;transform:translateY(20px) translateX(-50%);}}.feature-item{animation:fadeInUp 0.4s ease forwards;opacity:0;transform:translateY(10px);}@keyframes fadeInUp{to{opacity:1;transform:translateY(0);}}.particles-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1;}.particle{position:absolute;border-radius:50%;background:var(--primary-color);opacity:0.3;animation:particleFloat 15s infinite linear;}@keyframes particleFloat{0%{transform:translateY(100vh) rotate(0deg);opacity:0;}10%{opacity:0.3;}90%{opacity:0.3;}100%{transform:translateY(-100px) rotate(360deg);opacity:0;}}@media (max-width:600px){body{padding:12px;}.app-header h1{font-size:1.75rem;}.app-header h1 i{font-size:1.375rem;}.version-info-wrapper{flex-direction:column;align-items:flex-start;gap:6px;}.feature-item{padding:14px 16px;}.feature-item.is-expanded .textarea-container:not(:empty){padding-left:12px;padding-right:12px;}textarea{padding:12px;min-height:100px;font-size:0.85rem;}.fab-save{bottom:16px;right:16px;width:52px;height:52px;font-size:1.125rem;}.toast-item{min-width:85vw;margin:0 7.5vw;}}</style></head><body><div class="bg-animation"><div class="floating-shape shape-1"></div><div class="floating-shape shape-2"></div><div class="floating-shape shape-3"></div></div><div class="particles-container" id="particles-container"></div><div id="loading-overlay" class="loading-overlay"><div class="spinner"></div><p>正在初始化...</p></div><div id="app-container" class="app-container"><header class="app-header">        <h1>TCQT 模块设置</h1><div class="version-info"><div class="version-info-wrapper"><div class="version-item">宿主: <span id="hostVersion">加载中...</span></div><div class="version-item">模块: <span id="moduleVersion">加载中...</span></div></div></div><div class="action-status">已启用<span class="status-enabled" id="enabledCount">0</span>个功能，<span class="status-disabled" id="disabledCount">0</span>个功能未启用</div><div class="header-notice">被 <strong>红色</strong> 标记的功能有一定风险，请自行承担使用风险。<br>更改设置后需保存并重启宿主才能生效。</div></header><main><div id="feature-list" class="feature-list"></div></main><footer class="footer-link"><a id="issueLink" href="https://github.com/callng/TCQT/issues" target="_blank" title="有问题？去反馈" rel="noopener noreferrer"><i class="bi bi-github"></i> 有问题？去反馈</a></footer></div><button id="btnSave" class="fab-save" title="保存设置" aria-label="保存设置" disabled><i class="bi bi-save-fill"></i></button><div id="toast-container" class="toast-container"></div><script>'use strict';const LONG_PRESS_DURATION = 500;class ParticleSystem {constructor(container) {this.container = container;this.particles = [];this.colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];this.init();}init() {for (let i = 0; i < 15; i++) {this.createParticle();}}createParticle() {const particle = document.createElement('div');particle.className = 'particle';const size = Math.random() * 6 + 2;const color = this.colors[Math.floor(Math.random() * this.colors.length)];const left = Math.random() * 100;const duration = Math.random() * 20 + 10;const delay = Math.random() * 5;particle.style.width = `${size}px`;particle.style.height = `${size}px`;particle.style.backgroundColor = color;particle.style.left = `${left}%`;particle.style.animationDuration = `${duration}s`;particle.style.animationDelay = `${delay}s`;this.container.appendChild(particle);setTimeout(() => {if (particle.parentNode) {particle.parentNode.removeChild(particle);}this.createParticle();}, duration * 1000);}}class TCQTService {constructor() {this.isAvailable = typeof TCQT !== 'undefined';this.hostInfo = null;this.moduleInfo = null;}checkAvailability() {return this.isAvailable;}getHostInfo() {if (!this.isAvailable || this.hostInfo) return this.hostInfo;try {this.hostInfo = {name: TCQT.getHostName() || 'QQ',version: TCQT.getHostVersion() || '未知',channel: TCQT.getHostChannel() || '未知'};} catch (error) {console.error('获取宿主信息失败:', error);}return this.hostInfo;}getModuleInfo() {if (!this.isAvailable || this.moduleInfo) return this.moduleInfo;try {this.moduleInfo = {name: TCQT.getModuleName() || 'TCQT',version: TCQT.getModuleVersion() || '未知'};} catch (error) {console.error('获取模块信息失败:', error);}return this.moduleInfo;}getFeaturesConfig() {if (!this.isAvailable) return [];try {const configJson = TCQT.getFeaturesConfig();const features = JSON.parse(configJson);return Array.isArray(features) ? features.sort((a, b) => (a.uiOrder || 1000) - (b.uiOrder || 1000)) : [];} catch (error) {console.error('获取功能配置失败:', error);return [];}}getSetting(key) {if (!this.isAvailable) return { value: false };try {return JSON.parse(TCQT.getSetting(key));} catch (error) {console.error(`获取设置 ${key} 失败:`, error);return { value: false };}}saveBooleanSetting(key, value) {if (!this.isAvailable) return false;try {TCQT.saveValueB(key, value);return true;} catch (error) {console.error(`保存布尔设置 ${key} 失败:`, error);return false;}}saveStringSetting(key, value) {if (!this.isAvailable) return false;try {TCQT.saveValueS(key, value);return true;} catch (error) {console.error(`保存字符串设置 ${key} 失败:`, error);return false;}}getEnabledActionCount() {if (!this.isAvailable) return 0;try {return TCQT.getEnabledActionCount();} catch (error) {console.error('获取启用功能数量失败:', error);return 0;}}getDisabledActionCount() {if (!this.isAvailable) return 0;try {return TCQT.getDisabledActionCount();} catch (error) {console.error('获取禁用功能数量失败:', error);return 0;}}showToast(message) {if (!this.isAvailable) return false;try {TCQT.toast(message);return true;} catch (error) {console.error('显示Toast失败:', error);return false;}}clearConfig() {if (!this.isAvailable) return false;try {TCQT.clear();return true;} catch (error) {console.error('清空配置失败:', error);return false;}}exitApp() {if (!this.isAvailable) return false;try {TCQT.exitApp();return true;} catch (error) {console.error('退出应用失败:', error);return false;}}openUrlInDefaultBrowser(url) {if (!this.isAvailable) return false;try {TCQT.openUrlInDefaultBrowser(url);return true;} catch (error) {console.error('打开外部浏览器失败:', error);return false;}}isDarkModeByHost() {if (!this.isAvailable) return false;try {return TCQT.isDarkModeByHost();} catch (error) {console.error('检查暗色模式失败:', error);return false;}}}class AppState {constructor() {this.features = [];this.isInjected = false;this.hostInfo = null;this.moduleInfo = null;}setFeatures(features) {this.features = features;}setInjected(injected) {this.isInjected = injected;}setHostInfo(hostInfo) {this.hostInfo = hostInfo;}setModuleInfo(moduleInfo) {this.moduleInfo = moduleInfo;}getHostName() {return this.hostInfo?.name || '宿主';}}class UIManager {constructor() {this.elements = this.initializeElements();}initializeElements() {return {loadingOverlay: document.getElementById('loading-overlay'),appContainer: document.getElementById('app-container'),hostVersion: document.getElementById('hostVersion'),moduleVersion: document.getElementById('moduleVersion'),featureList: document.getElementById('feature-list'),btnSave: document.getElementById('btnSave'),toastContainer: document.getElementById('toast-container'),enabledCount: document.getElementById('enabledCount'),disabledCount: document.getElementById('disabledCount')};}setVersionDisplay(element, text, isSuccess) {if (!element) return;element.textContent = text;element.className = isSuccess ? 'version-success' : 'version-fail';}updateActionStatus(enabledCount, disabledCount) {this.elements.enabledCount.textContent = enabledCount;this.elements.disabledCount.textContent = disabledCount;}createFeatureElement(feature, index) {const item = document.createElement('div');item.className = 'feature-item';item.dataset.key = feature.key;item.style.animationDelay = `${index * 50}ms`;const header = document.createElement('div');header.className = 'feature-header';const title = document.createElement('div');title.className = 'feature-title';title.style.color = feature.color || 'inherit';title.innerHTML = `<i class="bi bi-chevron-down icon-toggle"></i><span>${feature.label}</span>`;const switchWrapper = document.createElement('div');switchWrapper.className = 'switch-container';const switchLabel = document.createElement('label');switchLabel.className = 'switch';const switchInput = document.createElement('input');switchInput.type = 'checkbox';switchInput.id = `switch-${feature.key}`;switchInput.setAttribute('aria-label', `切换 ${feature.label}`);switchInput.addEventListener('click', e => e.stopPropagation());const slider = document.createElement('span');slider.className = 'slider';switchLabel.appendChild(switchInput);switchLabel.appendChild(slider);switchWrapper.appendChild(switchLabel);header.append(title, switchWrapper);const desc = document.createElement('div');desc.className = 'feature-desc';desc.textContent = feature.desc;item.append(header, desc);if (feature.textareas && Array.isArray(feature.textareas)) {const textareaContainer = document.createElement('div');textareaContainer.className = 'textarea-container';feature.textareas.forEach(ta => {const textarea = document.createElement('textarea');textarea.id = `textarea-${ta.key}`;textarea.placeholder = ta.placeholder || '';textarea.rows = 3;textarea.setAttribute('aria-label', ta.placeholder || `输入 ${ta.key}`);textareaContainer.appendChild(textarea);});item.appendChild(textareaContainer);}header.addEventListener('click', (e) => {if (e.target === switchInput || e.target === slider || switchLabel.contains(e.target)) {return;}item.classList.toggle('is-expanded');});return item;}renderFeatures(features) {const fragment = document.createDocumentFragment();features.forEach((feature, index) => {const element = this.createFeatureElement(feature, index);fragment.appendChild(element);});this.elements.featureList.innerHTML = '';this.elements.featureList.appendChild(fragment);}setSaveButtonState(enabled) {this.elements.btnSave.disabled = !enabled;if (enabled) {this.elements.btnSave.classList.add('pulse');} else {this.elements.btnSave.classList.remove('pulse');}}showDOMToast(message) {const toast = document.createElement('div');toast.className = 'toast-item';toast.textContent = message;this.elements.toastContainer.appendChild(toast);setTimeout(() => toast.remove(), 3000);}showLoading() {this.elements.loadingOverlay.style.opacity = '1';this.elements.appContainer.classList.remove('visible');}hideLoading() {this.elements.loadingOverlay.style.opacity = '0';requestAnimationFrame(() => {this.elements.loadingOverlay.style.display = 'none';this.elements.appContainer.classList.add('visible');});}}class EventManager {constructor(app) {this.app = app;this.longPressTimer = null;this.isLongPress = false;this.LONG_PRESS_DURATION = 500;}initializeEvents() {this.initializeSaveButtonEvents();this.initializeFooterLinkEvents();}initializeSaveButtonEvents() {const saveButton = this.app.ui.elements.btnSave;saveButton.addEventListener('mousedown', (e) => {if (e.button !== 0) return;e.preventDefault();this.handlePressStart(e);});saveButton.addEventListener('mouseup', (e) => {e.preventDefault();this.handlePressEnd();});saveButton.addEventListener('mouseleave', () => this.handlePressCancel());saveButton.addEventListener('touchstart', (e) => {e.preventDefault();this.handlePressStart(e);});saveButton.addEventListener('touchend', (e) => {e.preventDefault();this.handlePressEnd();});saveButton.addEventListener('touchcancel', () => this.handlePressCancel());saveButton.addEventListener('click', (e) => {e.preventDefault();e.stopPropagation();});saveButton.addEventListener('contextmenu', (e) => {e.preventDefault();return false;});}initializeFooterLinkEvents() {const issueLink = document.getElementById('issueLink');if (!issueLink) return;issueLink.addEventListener('click', (e) => {const url = 'https://github.com/callng/TCQT/issues';const ok = this.app.tcqtService.openUrlInDefaultBrowser(url);if (ok) {e.preventDefault();e.stopPropagation();}});}handlePressStart(e) {if (e.type === 'mousedown' && e.button !== 0) return;if (this.longPressTimer) clearTimeout(this.longPressTimer);this.isLongPress = false;this.longPressTimer = setTimeout(() => {this.isLongPress = true;this.app.handleLongPress();}, this.LONG_PRESS_DURATION);}handlePressEnd() {if (this.longPressTimer) {clearTimeout(this.longPressTimer);this.longPressTimer = null;}if (!this.isLongPress) {setTimeout(() => {if (!this.isLongPress) {this.app.saveSettings();}}, 10);}}handlePressCancel() {if (this.longPressTimer) {clearTimeout(this.longPressTimer);this.longPressTimer = null;}this.isLongPress = false;}}class TCQTApp {constructor() {this.tcqtService = new TCQTService();this.state = new AppState();this.ui = new UIManager();this.eventManager = new EventManager(this);this.particleSystem = new ParticleSystem(document.getElementById('particles-container'));}applyTheme() {try {if (this.tcqtService.isDarkModeByHost()) {document.body.classList.add('dark-mode');}} catch (e) {console.error('应用主题失败:', e);}}async initialize() {this.applyTheme();this.ui.showLoading();try {await Promise.all([this.loadFeaturesConfig(),this.loadVersionInfo()]);this.renderUI();this.initializeSettings();this.eventManager.initializeEvents();} catch (error) {console.error('应用初始化失败:', error);this.handleInitializationError();} finally {this.ui.hideLoading();}}async loadFeaturesConfig() {const features = this.tcqtService.getFeaturesConfig();this.state.setFeatures(features);}async loadVersionInfo() {return new Promise(resolve => {setTimeout(() => {if (this.tcqtService.checkAvailability()) {const hostInfo = this.tcqtService.getHostInfo();const moduleInfo = this.tcqtService.getModuleInfo();if (hostInfo && moduleInfo) {this.state.setHostInfo(hostInfo);this.state.setModuleInfo(moduleInfo);this.state.setInjected(true);this.ui.setVersionDisplay(this.ui.elements.hostVersion,`${hostInfo.name} ${hostInfo.version} ${hostInfo.channel}`,true);this.ui.setVersionDisplay(this.ui.elements.moduleVersion,`${moduleInfo.name} ${moduleInfo.version}`,true);} else {this.setFallbackVersionInfo();}} else {this.setFallbackVersionInfo();}resolve();}, 100);});}setFallbackVersionInfo() {console.warn('TCQT对象未注入，使用模拟数据');this.state.setInjected(false);this.ui.setVersionDisplay(this.ui.elements.hostVersion, 'QQ 9.9.99 (环境异常)', false);this.ui.setVersionDisplay(this.ui.elements.moduleVersion, 'TCQT 9.9.99 (环境异常)', false);}renderUI() {this.ui.renderFeatures(this.state.features);this.updateActionStatus();}initializeSettings() {this.state.features.forEach(feature => {const checkbox = document.getElementById(`switch-${feature.key}`);if (!checkbox) return;if (this.state.isInjected) {const setting = this.tcqtService.getSetting(feature.key);checkbox.checked = !!setting.value;if (feature.textareas && Array.isArray(feature.textareas)) {feature.textareas.forEach(ta => {const textarea = document.getElementById(`textarea-${ta.key}`);if (textarea) {const textSetting = this.tcqtService.getSetting(ta.key);textarea.value = textSetting.value || '';}});}} else {checkbox.disabled = true;if (feature.textareas && Array.isArray(feature.textareas)) {feature.textareas.forEach(ta => {const textarea = document.getElementById(`textarea-${ta.key}`);if (textarea) textarea.disabled = true;});}}});this.ui.setSaveButtonState(this.state.isInjected);}updateActionStatus() {if (this.state.isInjected) {const enabledCount = this.tcqtService.getEnabledActionCount();const disabledCount = this.tcqtService.getDisabledActionCount();this.ui.updateActionStatus(enabledCount, disabledCount);} else {this.ui.updateActionStatus('-', '-');}}saveSettings() {if (!this.state.isInjected) {this.showToast('模块接口未注入，无法保存设置');return;}let hasError = false;this.state.features.forEach(feature => {const checkbox = document.getElementById(`switch-${feature.key}`);if (checkbox) {if (!this.tcqtService.saveBooleanSetting(feature.key, checkbox.checked)) {hasError = true;}}if (feature.textareas && Array.isArray(feature.textareas)) {feature.textareas.forEach(ta => {const textarea = document.getElementById(`textarea-${ta.key}`);if (textarea) {if (!this.tcqtService.saveStringSetting(ta.key, textarea.value.trim())) {hasError = true;}}});}});if (hasError) {this.showToast('部分设置保存失败，请重试');return;}this.updateActionStatus();const hostName = this.state.getHostName();if (confirm(`已保存，是否重启 ${hostName} 以应用更改？`)) {if (!this.tcqtService.exitApp()) {this.showToast(`重启 ${hostName} 失败，请手动重启`);}} else {this.showToast(`设置已保存，重启 ${hostName} 后生效`);}}handleLongPress() {if (!this.state.isInjected) {this.showToast('模块接口未注入，无法执行此操作');return;}if (confirm('清空所有配置？此操作不可撤销！')) {if (this.tcqtService.clearConfig()) {this.initializeSettings();if (confirm('配置已清空，重启以应用更改？')) {if (!this.tcqtService.exitApp()) {const hostName = this.state.getHostName();this.showToast(`重启 ${hostName} 失败，请手动重启`);}}} else {this.showToast('清空配置失败，请重试');}}}showToast(message) {if (!this.tcqtService.showToast(message)) {this.ui.showDOMToast(message);}}handleInitializationError() {this.ui.setVersionDisplay(this.ui.elements.hostVersion, '初始化异常', false);this.ui.setVersionDisplay(this.ui.elements.moduleVersion, '初始化异常', false);this.ui.setSaveButtonState(false);}}if (document.readyState === 'loading') {document.addEventListener('DOMContentLoaded', () => {const app = new TCQTApp();app.initialize();});} else {const app = new TCQTApp();app.initialize();}</script></body></html>